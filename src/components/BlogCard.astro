---
interface Props {
  title: string;
  excerpt: string;
  url: string;
  image?: string;
  date: string;
  category?: string;
  index?: number;
}

const {
  title,
  excerpt,
  url,
  image,
  date,
  category,
  index = 0
} = Astro.props;

const delayClass = `animate-delay-${(index % 5) + 1}`;

// ZennのURLからOGP画像を取得する関数
async function getZennOgImage(targetUrl: string): Promise<string> {
  try {
    // ZennのURLからslugを抽出 (例: https://zenn.dev/user/articles/slug)
    const match = targetUrl.match(/zenn\.dev\/[^/]+\/articles\/([^/?#]+)/);
    if (!match) return '';

    const slug = match[1];
    const response = await fetch(`https://zenn.dev/api/articles/${slug}`);
    const data = await response.json();
    return data.article?.og_image_url || '';
  } catch {
    return '';
  }
}

// imageが空の場合、Zenn URLならAPIからOGP画像を取得
let resolvedImage = image || '';
if (!image && url) {
  if (url.includes('zenn.dev')) {
    resolvedImage = await getZennOgImage(url);
  }
}
---

<article class={`blog-card animate-on-scroll ${delayClass}`}>
  <img
    src={resolvedImage}
    alt={title}
    class="blog-card-image"
    onerror="this.src='https://via.placeholder.com/200x140/1a1a25/c9a227?text=Blog'"
    loading="lazy"
  />
  <div class="blog-card-content">
    <time class="blog-card-date">
      <i class="bi bi-calendar3 me-1"></i>{date}
      {category && (
        <span class="ms-3"><i class="bi bi-tag me-1"></i>{category}</span>
      )}
    </time>
    <h3 class="blog-card-title">{title}</h3>
    <p class="blog-card-excerpt">{excerpt}</p>
    <a href={url} target="_blank" rel="noopener" class="blog-card-link">
      Read More <i class="bi bi-arrow-right"></i>
    </a>
  </div>
</article>
